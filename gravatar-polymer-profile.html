<link rel="import" href="../core-collapse/core-collapse.html">
<link rel="import" href="../core-icon/core-icon.html">
<link rel="import" href="../core-icons/core-icons.html">
<link rel="import" href="../core-icons/image-icons.html">
<link rel="import" href="../core-icons/maps-icons.html">
<link rel="import" href="../core-icons/social-icons.html">
<link rel="import" href="../core-image/core-image.html">
<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-shadow/paper-shadow.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../polymer-jsonp/polymer-jsonp.html">
<link rel="import" href="../polymer/polymer.html">

<!--
This is a profile element that can fetch from Gravatar.

##### Example

    <gravatar-polymer-profile hash="{{hash}}"></gravatar-polymer-profile>

@element gravatar-polymer-profile
@blurb This is a profile element that can fetch from Gravatar.
@status beta
@homepage https://github.com/vanxrice/gravatar-polymer-profile
@demo http://vanxrice.github.io/gravatar-polymer-profile/components/gravatar-polymer-profile/demo.html
-->

<polymer-element name="gravatar-polymer-profile" attributes="hash" horizontal layout>

  <template is="auto binding">

    <link rel="stylesheet" href="gravatar-polymer-profile.css">

    <polymer-jsonp auto handleAs="json" response="{{response}}"
      url="https://en.gravatar.com/{{hash}}.json?callback="
      on-polymer-response="{{onResponse}}"></polymer-jsonp>

    <paper-shadow z="3">

      <div id="container" style="background-color: {{profileBackgroundColor}}; width: 375px;" vertical>
        <div id="profile-header" horizontal wrap justified layout>

          <paper-spinner active></paper-spinner>

          <template if="{{profileImgSrc}}">
            <paper-shadow id="profileImgShadow" class="profile-img" on-tap="{{profileImgAnimate}}" z="0">
              <core-image sizing="cover" fade src="{{profileImgSrc}}" class="profile-img"></core-image>
            </paper-shadow>
          </template>

          <div id="profile-details" flex vertical layout>
            <div flex horizontal end-justified end layout>
              <div flex class="header-font" if="{{displayName}}">{{displayName}}</div>

              <template if="{{aboutMe}}">
                <paper-button id="aboutMeButton" raised noink class="header-detail-font" on-click="{{toggleCollapse}}">
                  <div flex>About Me</div>
                  <core-icon id="aboutMeCollapseIcon" icon="expand-more"></core-icon>
                </paper-button>
              </template>
            </div>

            <template if="{{currentLocation}}">
              <div class="header-detail-font" if="{{currentLocation}}">
                <core-icon id="maps-icon" icon="maps:pin-drop"></core-icon>
                {{currentLocation}}
              </div>
            </template>
          </div>
        </div>

        <core-collapse id="aboutMeCollapse" class="header-detail-font">{{aboutMe}}</core-collapse>

        <div id="profiles" horizontal around-justified layout wrap>
          <template id="profile-tmpl" repeat="{{accounts}}">
            <a href="{{url || value}}" class="profiles-link">
              <!-- Gravatar officially supported and verified sites -->
              <template if="{{domain == 'linkedin.com'}}">
                  <paper-icon-button icon="social:post-linkedin"></core-icon>
              </template>
              <template if="{{domain == 'profiles.google.com' || domain == 'plus.google.com'}}">
                <paper-icon-button icon="social:post-gplus"></paper-icon-button>
              </template>
              <template if="{{domain == 'blogger.com'}}">
                <paper-icon-button icon="social:post-blogger"></paper-icon-button>
              </template>
              <template if="{{domain == 'twitter.com'}}">
                <paper-icon-button icon="social:post-twitter"></paper-icon-button>
              </template>
              <template if="{{domain == 'facebook.com'}}">
                <paper-icon-button icon="social:post-facebook"></paper-icon-button>
              </template>
              <template if="{{domain == 'youtube.com'}}">
                <paper-icon-button icon="social:post-youtube"></paper-icon-button>
              </template>
              <template if="{{domain == 'instagram.com'}}">
                <paper-icon-button icon="social:post-instagram"></paper-icon-button>
              </template>
              <template if="{{domain == 'flickr.com'}}">
                <paper-icon-button icon="image:collections"></paper-icon-button>
              </template>
              <template if="{{domain == 'goodreads.com'}}">
                <paper-icon-button icon="book"></paper-icon-button>
              </template>
              <template if="{{domain == 'tumblr.com'}}">
                <paper-icon-button icon="social:post-tumblr"></paper-icon-button>
              </template>
              <template if="{{domain == 'vimeo.com'}}">
                <paper-icon-button icon="image:movie-creation"></paper-icon-button>
              </template>
              <!-- TODO foursquare -->
              <!-- TODO Tripit -->
              <!-- TODO Wordpress -->
              <!-- TODO Yahoo! -->

              <!-- Custom sites, I use title attribute to determine the icon to use, in this case the value attribute is used as the referenced URL. -->
              <template if="{{title == 'github.com'}}">
                <paper-icon-button icon="social:post-github"></paper-icon-button>
              </template>
            </a>
          </template>
        </div>
      
        <content></content>
    </div>
  </paper-shadow>

  </template>

  <script>

    Polymer('gravatar-polymer-profile', {
      /**
       * The `hash` attribute sets the Gravatar hash to fetch, which is just an md5 of the desired email address. See: http://en.gravatar.com/site/implement/hash/
       *
       * @attribute hash
       * @type string
       * @default ''
       */
      hash: '',

      toggleCollapse: function() {
        this.$.aboutMeCollapse.toggle();
        var coreIcon = this.$.aboutMeCollapseIcon;
        if (coreIcon.icon == 'expand-less') {
          coreIcon.icon = 'expand-more';
        } else {
          coreIcon.icon = 'expand-less';
        }
      },

      profileImgAnimate: function(e) { // TODO consider removing, set z=3
        var profileShadow = this.shadowRoot.querySelector('#profileImgShadow');
        if (!profileShadow.down) {
          profileShadow.setZ(profileShadow.z + 1);
          if (profileShadow.z === 5) {
            profileShadow.down = true;
          }
        } else {
          profileShadow.setZ(profileShadow.z - 1);
          if (profileShadow.z === 0) {
            profileShadow.down = false;
          }
        }
      },

      onResponse: function(e) {
        var json = e.detail.response;
        if (json) {
          var entry = json['entry'];
          if (entry) {
            var entry = entry[0];
            if (entry) {
              // remove spinner
              var spinner = this.shadowRoot.querySelector('paper-spinner');
              spinner.remove();

              if (entry['displayName']) {
                this.displayName = entry['displayName'];
              }

              if (entry['currentLocation']) {
                this.currentLocation = entry['currentLocation'];
              }

              if (entry['thumbnailUrl']) {
                this.profileImgSrc = entry['thumbnailUrl'];
              }

              if (entry['aboutMe']) {
                this.aboutMe = entry['aboutMe'];
              }

              if (entry['profileBackground']) {
                if (entry['profileBackground']['color']) {
                  this.profileBackgroundColor = entry['profileBackground']['color'];
                }
              }

              if (entry['accounts']) {
                this.accounts = entry['accounts'];
              }
              if (entry['urls']) {
                this.accounts = this.accounts.concat(entry['urls']);
              }
              this.accounts.sort(function(x, y) {
                var x1, y1;
                x1 = x.domain || x.title;
                y1 = y.domain || y.title;
                if (x1 < y1) {
                    return -1;
                }
                if (x1 > y1) {
                    return 1;
                }
                return 0;
              });
            }
          }
        }
      }

    });

  </script>

</polymer-element>
